<?php
include "database/db.php";

// Fetch universities once
$universities = [];
$result = $conn->query("SELECT * FROM universities");
while ($row = $result->fetch_assoc()) {
    $universities[] = $row;
}
?>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ubelt Grabs</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">

<div class="container py-4">

  <!-- Header -->
  <header class="text-center mb-4">
    <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" 
         style="width:80px;height:80px;font-size:1.5rem;">UG</div>
    <h1 class="mt-3 fw-bold">UBELT GRABS</h1>
    <p class="text-muted">University food delivery ‚Äî select Buyer or Seller</p>
  </header>

  <!-- Home screen -->
  <main id="screen-home" class="card shadow-sm p-4">
    <h2 class="h5 fw-bold">Welcome</h2>
    <p class="small text-muted">Choose a role to continue.</p>
    <div class="row g-3 mt-2">
      <div class="col-6">
        <button id="btnBuyer" class="btn btn-danger w-100 py-3">üõí Buyer</button>
      </div>
      <div class="col-6">
        <button id="btnSeller" class="btn btn-outline-secondary w-100 py-3">üè™ Seller</button>
      </div>
    </div>
  </main>

  <!-- Buyer screen -->
<section id="screen-buyer" class="d-none">
  <div class="d-flex justify-content-between align-items-center my-3">
    <div>
      <h2 class="h5 fw-bold">Buyer ‚Äî Browse Products</h2>
      <p class="text-muted small mb-0">Participating schools only</p>
    </div>
    <button id="buyer-back" class="btn btn-link">‚Üê Back</button>
  </div>

  <div class="row g-2 mb-3">
    <div class="col-6 col-md-4">
      <select id="buyerUniversity" class="form-select">
        <option value="">All Schools</option>
        <?php foreach($universities as $uni): ?>
          <option value="<?= $uni['id'] ?>"><?= htmlspecialchars($uni['name']) ?></option>
        <?php endforeach; ?>
      </select>
    </div>
    <div class="col-6 col-md-8">
      <input id="buyerSearch" type="search" class="form-control" placeholder="Search products...">
    </div>
  </div>

  <div id="buyerGrid" class="row g-3">
    <?php
    include "database/db.php";
    $result = $conn->query("SELECT p.*, u.name AS university 
                            FROM products p 
                            JOIN universities u ON p.university_id = u.id 
                            ORDER BY p.created_at DESC");

    if ($result && $result->num_rows > 0) {
        while ($row = $result->fetch_assoc()) {
            echo "<div class='col-md-4'>
                    <div class='card h-100'>
                        <img src='".(!empty($row['image_url']) ? $row['image_url'] : "https://via.placeholder.com/150")."' class='card-img-top'>
                        <div class='card-body'>
                            <h5 class='card-title'>".htmlspecialchars($row['name'])."</h5>
                            <p class='card-text text-muted'>‚Ç±".number_format($row['price'], 2)." ‚Äî ".htmlspecialchars($row['university'])."</p>
                            <p class='small'>".htmlspecialchars($row['description'])."</p>";
            if (!empty($row['fb_page'])) {
                echo "<a href='".htmlspecialchars($row['fb_page'])."' target='_blank' class='btn btn-sm btn-danger'>Facebook Page</a>";
            }
            echo        "</div>
                    </div>
                  </div>";
        }
    } else {
        echo "<div class='alert alert-secondary'>No products available yet.</div>";
    }
    ?>
  </div>
  <div id="buyerEmpty" class="alert alert-secondary d-none mt-3">No products found.</div>
</section>

  <!-- Seller screen -->
  <section id="screen-seller" class="d-none">
    <div class="d-flex justify-content-between align-items-center my-3">
      <div>
        <h2 class="h5 fw-bold">Seller Dashboard</h2>
        <p class="small text-muted">Add products and link your FB page</p>
      </div>
      <button id="seller-back" class="btn btn-link">‚Üê Back</button>
    </div>

    <?php
    // Display success/error messages
    if (isset($_GET['success'])) {
        switch ($_GET['success']) {
            case '1':
                echo '<div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> Product added successfully.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>';
                break;
            case 'product_updated':
                echo '<div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> Product updated successfully.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>';
                break;
            case 'product_deleted':
                echo '<div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> Product deleted successfully.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>';
                break;
        }
    }
    
    if (isset($_GET['error'])) {
        switch ($_GET['error']) {
            case 'no_product_id':
                echo '<div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> No product ID provided.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>';
                break;
            case 'product_not_found':
                echo '<div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> Product not found.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>';
                break;
        }
    }
    ?>

    <form id="sellerForm" method="post" action="database/add_product.php" class="card card-body shadow-sm mb-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Product name</label>
          <input name="pName" required class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Price (‚Ç±)</label>
          <input name="pPrice" type="number" step="0.01" required class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Category</label>
          <select name="pCategory" class="form-select">
            <option value="rice">Rice</option>
            <option value="noodles">Noodles</option>
            <option value="snacks">Snacks</option>
            <option value="drinks">Drinks</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">University</label>
          <select name="pUniversity" required class="form-select">
            <?php foreach($universities as $uni): ?>
              <option value="<?= $uni['id'] ?>"><?= htmlspecialchars($uni['name']) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Facebook page (optional)</label>
          <input name="pFB" type="url" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Image URL (optional)</label>
          <input name="pImage" type="url" class="form-control">
        </div>
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea name="pDesc" rows="2" class="form-control"></textarea>
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-danger flex-fill">Add Product</button>
        <button type="reset" class="btn btn-outline-secondary flex-fill">Clear</button>
      </div>
    </form>

    <h3 class="h6 fw-bold mb-2">My Products</h3>
    <div id="sellerList" class="vstack gap-3">
      <?php
      // Display seller's products with edit/delete buttons
      $seller_products = $conn->query("SELECT p.*, u.name AS university_name 
                                      FROM products p 
                                      LEFT JOIN universities u ON p.university_id = u.id 
                                      ORDER BY p.created_at DESC");
      
      if ($seller_products && $seller_products->num_rows > 0) {
          while ($product = $seller_products->fetch_assoc()) {
              echo "<div class='card mb-2 shadow-sm'>";
              echo "<div class='card-body p-2 d-flex gap-2'>";
              
              // Product image
              if (!empty($product['image_url'])) {
                  echo "<img src='".htmlspecialchars($product['image_url'])."' alt='Product Image' style='width:72px;height:72px;object-fit:cover;border-radius:.5rem'>";
              } else {
                  echo "<div class='bg-light rounded d-flex align-items-center justify-content-center' style='width:72px;height:72px;'>";
                  echo "<span class='text-muted small'>No Image</span>";
                  echo "</div>";
              }
              
              echo "<div class='flex-fill'>";
              echo "<div class='d-flex justify-content-between align-items-start'>";
              echo "<div>";
              echo "<div class='fw-semibold'>".htmlspecialchars($product['name'])."</div>";
              echo "<div class='small text-muted'>".htmlspecialchars($product['university_name'])." ‚Ä¢ ".ucfirst(htmlspecialchars($product['category']))."</div>";
              echo "</div>";
              echo "<div class='text-danger fw-bold'>‚Ç±".number_format($product['price'], 2)."</div>";
              echo "</div>";
              
              if (!empty($product['description'])) {
                  echo "<div class='small text-muted mt-2'>".htmlspecialchars($product['description'])."</div>";
              }
              
              echo "<div class='mt-2 d-flex gap-2 align-items-center'>";
              if (!empty($product['fb_page'])) {
                  echo "<a href='".htmlspecialchars($product['fb_page'])."' target='_blank' class='btn btn-sm btn-outline-primary'>Facebook</a>";
              }
              echo "<a href='database/edit_product.php?id=".$product['id']."' class='btn btn-sm btn-outline-warning'>Edit</a>";
              echo "<a href='database/delete_product.php?id=".$product['id']."' class='btn btn-sm btn-outline-danger'>Delete</a>";
              echo "</div>";
              echo "</div>";
              echo "</div>";
              echo "</div>";
          }
      } else {
          echo "<div class='text-muted small'>No products yet. Add your first product above!</div>";
      }
      ?>
    </div>
  </section>

</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
  <div id="toast" class="toast text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="script.js"></script>
</body>
</html>
